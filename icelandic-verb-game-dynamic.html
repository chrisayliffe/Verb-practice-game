<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <meta name="robots" content="noindex,nofollow"/>
  <title>Icelandic Verb Practice Game (Dynamic)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; overflow-x: hidden; }
    body { font-family: 'Outfit', sans-serif; background:#fff; color:#121212; line-height:1.6; font-size:16px; padding:16px; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; color:#121212; }
    .subtitle { color:#666; margin-bottom: 16px; }
    .controls { background:#f9f9f9; padding:14px; border-radius:10px; margin-bottom:14px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .control-row { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; align-items:center; }
    .control-group { display:flex; flex-direction:column; gap:6px; }
    label { font-size:1rem; font-weight:600; color:#121212; }
    select, button { font-family:'Outfit',sans-serif; font-size:1.0625rem; padding:12px 16px; border-radius:8px; border:1px solid #ddd; background:white; color:#121212; cursor:pointer; transition:all .2s; }
    select:hover, select:focus { border-color:#21b766; outline:none; }
    button { font-weight:600; border:none; background:#21b766; color:white; }
    button:hover { background:#1a9654; transform:translateY(-1px); box-shadow:0 4px 12px rgba(33,183,102,.3); }
    button.secondary { background:#121212; color:#fff; }
    .mode-tabs { display:flex; gap:10px; margin-bottom:14px; }
    .mode-tab { flex:1; padding:14px; background:#f0f0f0; border:2px solid transparent; color:#666; font-weight:600; border-radius:8px; cursor:pointer; transition:all .2s; text-align:center; }
    .mode-tab.active { background:#fff; border-color:#21b766; color:#21b766; box-shadow:0 2px 8px rgba(33,183,102,.1); }
    .game-area { background:#fff; padding:18px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.08); margin-bottom:8px; }
    table { table-layout:fixed; width:100%; border-collapse:collapse; margin-bottom:12px; }
    th, td { padding:10px 8px; text-align:center; border:1px solid #e0e0e0; font-size:.9375rem; }
    th { background:#f5f5f5; font-weight:600; }
    input[type="text"] { width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-family:'Outfit',sans-serif; font-size:1.0625rem; transition:all .2s; }
    input[type="text"]:focus { outline:none; border-color:#21b766; }
    input.correct { border-color:#21b766; background:#f0fdf4; }
    input.incorrect { border-color:#f15d4e; background:#fef2f2; }
    .drag-tiles { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; min-height:70px; max-height:160px; overflow-y:auto; padding:10px; background:#f9f9f9; border-radius:8px; border:2px dashed #ddd; }
    .tile { padding:8px 14px; background:white; border:2px solid #21b766; border-radius:6px; cursor:grab; user-select:none; font-weight:500; font-size:.9375rem; transition:all .2s; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .tile.dragging { opacity:.5; cursor:grabbing; }
    .drop-zone { min-height:40px; background:#f9f9f9; border:2px dashed #ddd; border-radius:6px; display:flex; align-items:center; justify-content:center; transition:all .2s; }
    .drop-zone.drag-over { background:#e8f5e9; border-color:#21b766; }
    .drop-zone.correct { background:#f0fdf4; border-color:#21b766; }
    .drop-zone.incorrect { background:#fef2f2; border-color:#f15d4e; }
    .score { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#f9f9f9; border-radius:8px; margin-bottom:12px; }
    .score-item { display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.0625rem; }
    .score-value { font-size:1.625rem; color:#21b766; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .actions button { flex:1; min-width:150px; }
    .hidden { display:none !important; }
    .feedback { padding:14px; border-radius:8px; margin-top:16px; font-weight:600; font-size:1.0625rem; text-align:center; }
    .feedback.success { background:#f0fdf4; color:#21b766; border:2px solid #21b766; }
    .feedback.error { background:#fef2f2; color:#f15d4e; border:2px solid #f15d4e; }

    @media (max-width: 768px) {
      body { font-size:15px; }
      h1 { font-size:1.6rem; }
      .tile { font-size:.875rem; padding:6px 10px; }
      th, td { padding:8px 6px; }
      .drag-tiles { max-height:140px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="pageTitle">Icelandic Verb Practice Game</h1>
    <p id="pageSubtitle" class="subtitle">Loading lesson‚Ä¶</p>

    <div class="controls">
      <div class="control-row">
        <div class="control-group">
          <label for="verbSelect">Select Verb:</label>
          <select id="verbSelect"></select>
        </div>
        <div class="control-group" id="tenseControl">
          <label for="tenseSelect">Tense:</label>
          <select id="tenseSelect">
            <option value="present">N√∫t√≠√∞ (Present)</option>
            <option value="past">√û√°t√≠√∞ (Past)</option>
          </select>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="toggleAnswersBtn">Show Answers</button>
        </div>
      </div>
    </div>

    <div class="mode-tabs">
      <div class="mode-tab active" data-mode="fill">Fill in the Blank</div>
      <div class="mode-tab" data-mode="drag">Drag & Drop</div>
    </div>

    <div class="score">
      <div class="score-item"><span>Progress:</span><span class="score-value" id="scoreDisplay">0%</span></div>
      <div class="score-item"><span>Correct:</span><span class="score-value" id="correctCount">0</span></div>
    </div>

    <div class="game-area exercise-panels">
      <div id="fillMode">
        <table id="fillTable"></table>
        <div class="actions">
          <button id="checkFill">Check Answers</button>
          <button class="secondary" id="resetFill">Reset</button>
        </div>
      </div>

      <div id="dragMode" class="hidden">
        <div class="drag-tiles" id="dragTiles"></div>
        <table id="dragTable"></table>
        <div class="actions">
          <button id="checkDrag">Check Answers</button>
          <button class="secondary" id="resetDrag">Reset</button>
        </div>
      </div>

      <div id="feedback"></div>
    </div>
  </div>

  <script>
    // ----------- CONFIG / STATE -----------
    const SHEET_ID = "1TvQ8qTJ2IkaRbyJa3JNbjbLOM0peubS0VDNGupHwZes";
    const params = new URLSearchParams(location.search);
    const TAB = params.get("lesson") || "Lesson 1";

    let VERB_DATA = []; // [{ verb, tenses: {present|past:{singular:{1,2,3}, plural:{1,2,3}}}, ui:{pronouns}}]
    let CONFIG = { showTenses: true };
    let currentMode = 'fill';
    let showingAnswers = false;
    let dragged = null;

    const els = {
      title: document.getElementById('pageTitle'),
      subtitle: document.getElementById('pageSubtitle'),
      verbSelect: document.getElementById('verbSelect'),
      tenseSelect: document.getElementById('tenseSelect'),
      tenseControl: document.getElementById('tenseControl'),
      toggleAnswersBtn: document.getElementById('toggleAnswersBtn'),
      fillTable: document.getElementById('fillTable'),
      dragTable: document.getElementById('dragTable'),
      dragTiles: document.getElementById('dragTiles'),
      scoreDisplay: document.getElementById('scoreDisplay'),
      correctCount: document.getElementById('correctCount'),
      feedback: document.getElementById('feedback'),
      fillMode: document.getElementById('fillMode'),
      dragMode: document.getElementById('dragMode'),
    };

    // ----------- LOAD LESSON -----------
    async function loadLesson() {
      els.subtitle.textContent = `Loading "${TAB}"‚Ä¶`;
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(TAB)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Could not read sheet. Is it shared as "Anyone with the link"?');

        // parse GViz JSON
        const text = await res.text();
        const json = JSON.parse(text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);\s*$/, ''));
        const table = json.table || { rows: [] };
        const rows2d = (table.rows || []).map(r => (r.c || []).map(c => (c && c.v != null ? String(c.v) : '')));

        // --- Config rows (A1:B3)
        const title = rows2d[0]?.[1] || TAB;
        const subtitle = rows2d[1]?.[1] || '';
        const showTenseVal = (rows2d[2]?.[1] || 'yes').toLowerCase();
        CONFIG.showTenses = showTenseVal === 'yes';

        els.title.textContent = title;
        els.subtitle.textContent = subtitle || (CONFIG.showTenses ? 'Practice present and past' : 'Practice present tense');

        // --- Find header row containing Verb + Tense
        let headerRowIndex = -1;
        for (let i = 0; i < rows2d.length; i++) {
          const lower = rows2d[i].map(s => (s || '').trim().toLowerCase());
          if (lower.some(v => v.startsWith('verb')) && lower.some(v => v.startsWith('tense'))) {
            headerRowIndex = i; break;
          }
        }
        if (headerRowIndex === -1) throw new Error('Could not find header row with "Verb" and "Tense".');

        // --- Build header map
        const headers = rows2d[headerRowIndex].map(h => (h || '').trim().toLowerCase());
        const idx = (name) => headers.indexOf(name.toLowerCase());
        const have = (name) => idx(name) !== -1;

        const needed = ['verb','tense','√©g','√æ√∫','hann/h√∫n/√æa√∞','vi√∞','√æi√∞','√æeir/√æ√¶r/√æau'];
        const missing = needed.filter(n => !have(n));
        if (missing.length) {
          console.warn('Missing expected headers:', missing);
        }

        // --- Build data rows
        const dataRows = rows2d.slice(headerRowIndex + 1).filter(r => (r[idx('verb')] || '').trim() && (r[idx('tense')] || '').trim());
        const byVerb = {};

        for (const r of dataRows) {
          const verb = (r[idx('verb')] || '').trim();
          const tense = (r[idx('tense')] || '').trim().toLowerCase(); // 'present' | 'past'
          if (!verb || !tense) continue;

          if (!byVerb[verb]) {
            byVerb[verb] = {
              verb,
              tenses: {
                present: { singular: {}, plural: {} },
                past:     { singular: {}, plural: {} }
              },
              ui: {
                pronouns: {
                  singular: { "1":"√©g", "2":"√æ√∫", "3":"hann / h√∫n / √æa√∞" },
                  plural:   { "1":"vi√∞","2":"√æi√∞","3":"√æeir / √æ√¶r / √æau" }
                }
              }
            };
          }

          const get = (k) => (idx(k) !== -1 ? (r[idx(k)] || '').trim() : '');

          byVerb[verb].tenses[tense].singular["1"] = get('√©g');
          byVerb[verb].tenses[tense].singular["2"] = get('√æ√∫');
          byVerb[verb].tenses[tense].singular["3"] = get('hann/h√∫n/√æa√∞');
          byVerb[verb].tenses[tense].plural["1"]   = get('vi√∞');
          byVerb[verb].tenses[tense].plural["2"]   = get('√æi√∞');
          byVerb[verb].tenses[tense].plural["3"]   = get('√æeir/√æ√¶r/√æau');
        }

        VERB_DATA = Object.values(byVerb);
        if (!VERB_DATA.length) throw new Error('No verb rows found under the header.');

        buildVerbSelect();
        applyShowTenses();
        attachHandlers();
        resetGame();
      } catch (err) {
        console.error(err);
        els.subtitle.textContent = 'Failed to load lesson.';
        showError(err.message || 'Failed to load lesson.');
      }
    }

    // ----------- UI BUILDERS -----------
    function buildVerbSelect(){
      els.verbSelect.innerHTML = '';
      VERB_DATA.forEach((v, i) => {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = 'a√∞ ' + v.verb;
        els.verbSelect.appendChild(opt);
      });
    }

    function applyShowTenses(){
      els.tenseControl.style.display = CONFIG.showTenses ? '' : 'none';
      if (!CONFIG.showTenses) els.tenseSelect.value = 'present';
    }

    function getCurrent(){
      const i = parseInt(els.verbSelect.value || '0', 10) || 0;
      const tense = (els.tenseSelect.value || 'present').toLowerCase();
      const verb = VERB_DATA[i];
      // If tense missing for a verb, fall back to present
      const tenses = verb.tenses[tense] && (verb.tenses[tense].singular["1"] || verb.tenses[tense].plural["1"])
        ? verb.tenses[tense]
        : verb.tenses['present'];
      return { verb, tenseData: tenses, pronouns: verb.ui.pronouns };
    }

    // ----------- MODES -----------
    function createFillTable(){
      const { tenseData, pronouns } = getCurrent();
      const T = els.fillTable;
      T.innerHTML = '';

      const headerRow = document.createElement('tr');
      ['', '1st Person', '2nd Person', '3rd Person'].forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      T.appendChild(headerRow);

      const mkRow = (label, number) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.textContent = label; tr.appendChild(th);
        ['1','2','3'].forEach(p=>{
          const td = document.createElement('td');
          const lab = document.createElement('div');
          lab.style.fontSize = '.9375rem';
          lab.style.color = '#666';
          lab.style.marginBottom = '6px';
          lab.textContent = pronouns[number][p];
          const input = document.createElement('input');
          input.type = 'text';
          input.dataset.correct = (tenseData[number][p] || '');
          input.dataset.number = number;
          input.dataset.person = p;
          td.appendChild(lab); td.appendChild(input); tr.appendChild(td);
        });
        T.appendChild(tr);
      };
      mkRow('Singular (Eintala)','singular');
      mkRow('Plural (Fleirtala)','plural');
    }

    function createDragTable(){
      const { tenseData, pronouns } = getCurrent();
      els.dragTable.innerHTML = '';
      els.dragTiles.innerHTML = '';

      // collect forms
      const forms = [];
      ['singular','plural'].forEach(n => ['1','2','3'].forEach(p => forms.push(tenseData[n][p] || '')));
      // shuffle
      forms.sort(() => Math.random() - 0.5);
      forms.forEach(f=>{
        const t = document.createElement('div');
        t.className = 'tile';
        t.textContent = f;
        t.draggable = true;
        t.addEventListener('dragstart', e => { dragged = t; t.classList.add('dragging'); });
        t.addEventListener('dragend', e => { t.classList.remove('dragging'); dragged = null; });
        els.dragTiles.appendChild(t);
      });

      const headerRow = document.createElement('tr');
      ['', '1st Person', '2nd Person', '3rd Person'].forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
      });
      els.dragTable.appendChild(headerRow);

      const mkRow = (label, number) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.textContent = label; tr.appendChild(th);

        ['1','2','3'].forEach(p=>{
          const td = document.createElement('td');

          const lab = document.createElement('div');
          lab.style.fontSize = '.9375rem';
          lab.style.color = '#666';
          lab.style.marginBottom = '6px';
          lab.textContent = pronouns[number][p];

          const dz = document.createElement('div');
          dz.className = 'drop-zone';
          dz.dataset.correct = (tenseData[number][p] || '');
          dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
          dz.addEventListener('dragleave', e => dz.classList.remove('drag-over'));
          dz.addEventListener('drop', e => {
            e.preventDefault(); dz.classList.remove('drag-over');
            if (!dragged) return;
            if (dz.firstChild) els.dragTiles.appendChild(dz.firstChild);
            dz.appendChild(dragged);
          });
          dz.addEventListener('click', () => {
            if (dz.firstChild) els.dragTiles.appendChild(dz.firstChild);
          });

          td.appendChild(lab); td.appendChild(dz); tr.appendChild(td);
        });

        els.dragTable.appendChild(tr);
      };

      mkRow('Singular (Eintala)','singular');
      mkRow('Plural (Fleirtala)','plural');
    }

    // ----------- ACTIONS / SCORING -----------
    function checkAnswers(){
      const inputs = els.fillTable.querySelectorAll('input');
      let correct = 0, total = inputs.length;
      inputs.forEach(input=>{
        const u = input.value.trim().toLowerCase();
        const c = (input.dataset.correct || '').trim().toLowerCase();
        if (u === c && c) { input.classList.add('correct'); input.classList.remove('incorrect'); correct++; }
        else if (u) { input.classList.add('incorrect'); input.classList.remove('correct'); }
        else { input.classList.remove('correct','incorrect'); }
      });
      updateScore(correct, total);
      showFeedback(correct, total);
    }

    function checkDragAnswers(){
      const zones = els.dragTable.querySelectorAll('.drop-zone');
      let correct = 0, total = zones.length;
      zones.forEach(z=>{
        const t = z.querySelector('.tile');
        if (t){
          const u = (t.textContent || '').trim().toLowerCase();
          const c = (z.dataset.correct || '').trim().toLowerCase();
          if (u === c && c) { z.classList.add('correct'); z.classList.remove('incorrect'); correct++; }
          else { z.classList.add('incorrect'); z.classList.remove('correct'); }
        } else {
          z.classList.remove('correct','incorrect');
        }
      });
      updateScore(correct, total);
      showFeedback(correct, total);
    }

    function updateScore(correct, total){
      const pct = total ? Math.round((correct/total)*100) : 0;
      els.scoreDisplay.textContent = pct + '%';
      els.correctCount.textContent = `${correct}/${total}`;
    }

    function showFeedback(correct, total){
      els.feedback.className = 'feedback';
      if (!total) { els.feedback.textContent = ''; return; }
      if (correct === total) { els.feedback.classList.add('success'); els.feedback.textContent = 'üéâ Perfect! All answers correct!'; }
      else if (correct > total / 2) { els.feedback.classList.add('success'); els.feedback.textContent = `Good job! ${correct} of ${total} correct.`; }
      else { els.feedback.classList.add('error'); els.feedback.textContent = `Keep practicing! ${correct} of ${total} correct.`; }
    }

    function toggleAnswers(){
      showingAnswers = !showingAnswers;
      const btn = els.toggleAnswersBtn;
      if (showingAnswers){
        btn.textContent = 'Hide Answers';
        if (currentMode === 'fill'){
          els.fillTable.querySelectorAll('input').forEach(i => { i.value = i.dataset.correct || ''; i.classList.add('correct'); });
        } else {
          els.dragTable.querySelectorAll('.drop-zone').forEach(z => {
            if (!z.querySelector('.tile') && z.dataset.correct){
              const hint = document.createElement('span');
              hint.style.color = '#21b766';
              hint.style.fontSize = '.875rem';
              hint.textContent = z.dataset.correct;
              z.appendChild(hint);
            }
          });
        }
      } else {
        btn.textContent = 'Show Answers';
        if (currentMode === 'fill'){
          els.fillTable.querySelectorAll('input').forEach(i => { i.value = ''; i.classList.remove('correct','incorrect'); });
        } else {
          els.dragTable.querySelectorAll('.drop-zone').forEach(z => { const s = z.querySelector('span'); if (s) s.remove(); z.classList.remove('correct','incorrect'); });
        }
      }
      postHeightSoon();
    }

    function resetGame(){
      showingAnswers = false;
      els.feedback.textContent = '';
      els.scoreDisplay.textContent = '0%';
      els.correctCount.textContent = '0/0';
      els.toggleAnswersBtn.textContent = 'Show Answers';

      if (currentMode === 'fill') { els.fillMode.classList.remove('hidden'); els.dragMode.classList.add('hidden'); createFillTable(); }
      else { els.fillMode.classList.add('hidden'); els.dragMode.classList.remove('hidden'); createDragTable(); }

      postHeightSoon();
    }

    function switchMode(mode){
      currentMode = mode;
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
      resetGame();
    }

    // ----------- HANDLERS -----------
    function attachHandlers(){
      els.toggleAnswersBtn.onclick = toggleAnswers;
      document.getElementById('checkFill').onclick = checkAnswers;
      document.getElementById('resetFill').onclick = resetGame;
      document.getElementById('checkDrag').onclick = checkDragAnswers;
      document.getElementById('resetDrag').onclick = resetGame;
      els.verbSelect.onchange = resetGame;
      els.tenseSelect.onchange = resetGame;
      document.querySelectorAll('.mode-tab').forEach(tab => tab.onclick = () => switchMode(tab.dataset.mode));
    }

    // ----------- AUTOSIZE FOR LEARNWORLDS -----------
    let _resizeTimer;
    function postHeightSoon(){
      clearTimeout(_resizeTimer);
      _resizeTimer = setTimeout(() => {
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        parent.postMessage({ type: 'IFRAME_HEIGHT', height: h }, '*');
      }, 120);
    }
    new ResizeObserver(postHeightSoon).observe(document.body);
    window.addEventListener('load', postHeightSoon);

    // ----------- INIT -----------
    loadLesson();
  </script>
</body>
</html>
