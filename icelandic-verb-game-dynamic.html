<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex,nofollow">
  <title>Icelandic Verb Practice Game (Dynamic)</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; overflow-x: hidden; }
    body { font-family: 'Outfit', sans-serif; background:#fff; color:#121212; line-height:1.6; font-size:16px; padding:16px; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { font-size: 2rem; font-weight: 600; margin-bottom: 6px; }
    .subtitle { color:#666; margin-bottom: 14px; }
    .controls { background:#f9f9f9; padding:14px; border-radius:10px; margin-bottom:14px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .control-row { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; align-items:center; }
    .control-group { display:flex; flex-direction:column; gap:5px; }
    label { font-size:1rem; font-weight:600; color:#121212; }
    select, button { font-family:'Outfit',sans-serif; font-size:1.0625rem; padding:12px 20px; border-radius:8px; border:1px solid #ddd; background:white; color:#121212; cursor:pointer; transition:all .2s; }
    select:hover, select:focus { border-color:#21b766; outline:none; }
    button { font-weight:600; border:none; background:#21b766; color:white; }
    button:hover { background:#1a9654; transform:translateY(-1px); box-shadow:0 4px 12px rgba(33,183,102,.3); }
    button.secondary { background:#121212; }
    .mode-tabs { display:flex; gap:10px; margin-bottom:14px; }
    .mode-tab { flex:1; padding:14px; background:#f0f0f0; border:2px solid transparent; color:#666; font-weight:600; border-radius:8px; cursor:pointer; transition:all .2s; text-align:center; }
    .mode-tab.active { background:#fff; border-color:#21b766; color:#21b766; box-shadow:0 2px 8px rgba(33,183,102,.1); }
    .game-area { background:#fff; padding:18px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.08); margin-bottom:8px; }
    table { table-layout:fixed; width:100%; border-collapse:collapse; margin-bottom:12px; }
    th, td { padding:10px 8px; text-align:center; border:1px solid #e0e0e0; font-size:.9375rem; }
    th { background:#f5f5f5; font-weight:600; }
    input[type="text"] { width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-family:'Outfit',sans-serif; font-size:1.0625rem; transition:all .2s; }
    input[type="text"]:focus { outline:none; border-color:#21b766; }
    input.correct { border-color:#21b766; background:#f0fdf4; }
    input.incorrect { border-color:#f15d4e; background:#fef2f2; }
    .drag-tiles { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; min-height:70px; max-height:140px; overflow-y:auto; padding:10px; background:#f9f9f9; border-radius:8px; border:2px dashed #ddd; }
    .tile { padding:8px 14px; background:white; border:2px solid #21b766; border-radius:6px; cursor:grab; user-select:none; font-weight:500; font-size:.9375rem; transition:all .2s; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    .tile.dragging { opacity:.5; cursor:grabbing; }
    .drop-zone { min-height:40px; background:#f9f9f9; border:2px dashed #ddd; border-radius:6px; display:flex; align-items:center; justify-content:center; transition:all .2s; }
    .drop-zone.drag-over { background:#e8f5e9; border-color:#21b766; }
    .drop-zone.correct { background:#f0fdf4; border-color:#21b766; }
    .drop-zone.incorrect { background:#fef2f2; border-color:#f15d4e; }
    .score { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#f9f9f9; border-radius:8px; margin-bottom:12px; }
    .score-item { display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.0625rem; }
    .score-value { font-size:1.625rem; color:#21b766; }
    .hidden { display:none !important; }
    .feedback { padding:14px; border-radius:8px; margin-top:16px; font-weight:600; font-size:1.0625rem; text-align:center; }
    .feedback.success { background:#f0fdf4; color:#21b766; border:2px solid #21b766; }
    .feedback.error { background:#fef2f2; color:#f15d4e; border:2px solid #f15d4e; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="pageTitle">Icelandic Verb Practice Game</h1>
    <p id="pageSubtitle" class="subtitle">Loading lesson‚Ä¶</p>

    <div class="controls">
      <div class="control-row">
        <div class="control-group">
          <label for="verbSelect">Select Verb:</label>
          <select id="verbSelect"></select>
        </div>
        <div class="control-group" id="tenseControl">
          <label for="tenseSelect">Tense:</label>
          <select id="tenseSelect">
            <option value="present">N√∫t√≠√∞ (Present)</option>
            <option value="past">√û√°t√≠√∞ (Past)</option>
          </select>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="toggleAnswersBtn">Show Answers</button>
        </div>
      </div>
    </div>

    <div class="mode-tabs">
      <div class="mode-tab active" data-mode="fill">Fill in the Blank</div>
      <div class="mode-tab" data-mode="drag">Drag & Drop</div>
    </div>

    <div class="score">
      <div class="score-item"><span>Progress:</span><span class="score-value" id="scoreDisplay">0%</span></div>
      <div class="score-item"><span>Correct:</span><span class="score-value" id="correctCount">0</span></div>
    </div>

    <div class="game-area exercise-panels">
      <div id="fillMode">
        <table id="fillTable"></table>
        <div class="actions">
          <button id="checkFill">Check Answers</button>
          <button class="secondary" id="resetFill">Reset</button>
        </div>
      </div>

      <div id="dragMode" class="hidden">
        <div class="drag-tiles" id="dragTiles"></div>
        <table id="dragTable"></table>
        <div class="actions">
          <button id="checkDrag">Check Answers</button>
          <button class="secondary" id="resetDrag">Reset</button>
        </div>
      </div>

      <div id="feedback"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1TvQ8qTJ2IkaRbyJa3JNbjbLOM0peubS0VDNGupHwZes";
    const params = new URLSearchParams(location.search);
    const TAB = params.get("lesson") || "Lesson 1";

    let VERB_DATA = [];
    let CONFIG = { showTenses: true };
    let currentMode = 'fill';
    let showingAnswers = false;

    const els = {
      title: document.getElementById('pageTitle'),
      subtitle: document.getElementById('pageSubtitle'),
      verbSelect: document.getElementById('verbSelect'),
      tenseSelect: document.getElementById('tenseSelect'),
      tenseControl: document.getElementById('tenseControl'),
      toggleAnswersBtn: document.getElementById('toggleAnswersBtn'),
      fillTable: document.getElementById('fillTable'),
      dragTable: document.getElementById('dragTable'),
      dragTiles: document.getElementById('dragTiles'),
      scoreDisplay: document.getElementById('scoreDisplay'),
      correctCount: document.getElementById('correctCount'),
      feedback: document.getElementById('feedback'),
      fillMode: document.getElementById('fillMode'),
      dragMode: document.getElementById('dragMode'),
    };

    // üß© Load lesson dynamically from Google Sheets
    async function loadLesson() {
      els.subtitle.textContent = `Loading "${TAB}"‚Ä¶`;
      try {
        const res = await fetch(
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(TAB)}`
        );
        const text = await res.text();
        const json = JSON.parse(text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);\s*$/, ''));
        const rows2d = (json.table.rows || []).map(r => (r.c || []).map(c => (c && c.v != null ? String(c.v) : '')));

        // Config
        const title = rows2d[0]?.[1] || TAB;
        const subtitle = rows2d[1]?.[1] || '';
        const showTenses = (rows2d[2]?.[1] || 'yes').toLowerCase() === 'yes';
        CONFIG.showTenses = showTenses;
        els.title.textContent = title;
        els.subtitle.textContent = subtitle;

        // Find header row
        const headerRowIndex = rows2d.findIndex(r => r.some(v => v.toLowerCase() === 'verb'));
        if (headerRowIndex === -1) throw new Error('Could not find header row.');
        const headers = rows2d[headerRowIndex].map(h => h.trim().toLowerCase());
        const data = rows2d.slice(headerRowIndex + 1).filter(r => r[0]);

        // Build data
        VERB_DATA = data.map(r => {
          const get = k => r[headers.indexOf(k)] || '';
          return {
            verb: get('verb'),
            tenses: {
              present: {
                singular: { 1: get('√©g'), 2: get('√æ√∫'), 3: get('hann/h√∫n/√æa√∞') },
                plural: { 1: get('vi√∞'), 2: get('√æi√∞'), 3: get('√æeir/√æ√¶r/√æau') }
              }
            },
            ui: { pronouns: {
              singular: { 1:'√©g', 2:'√æ√∫', 3:'hann / h√∫n / √æa√∞' },
              plural: { 1:'vi√∞', 2:'√æi√∞', 3:'√æeir / √æ√¶r / √æau' }
            }}
          };
        });

        buildVerbSelect();
        attachHandlers();
        resetGame();

      } catch (err) {
        els.subtitle.textContent = 'Error loading sheet';
        console.error(err);
      }
    }

    function buildVerbSelect(){
      els.verbSelect.innerHTML = '';
      VERB_DATA.forEach((v, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = v.verb;
        els.verbSelect.appendChild(opt);
      });
    }

    function attachHandlers(){
      els.toggleAnswersBtn.onclick = toggleAnswers;
      document.getElementById('checkFill').onclick = checkAnswers;
      document.getElementById('resetFill').onclick = resetGame;
    }

    function getCurrentData(){
      const i = els.verbSelect.value || 0;
      const verb = VERB_DATA[i];
      return { data: verb.tenses.present, pronouns: verb.ui.pronouns };
    }

    function createFillTable(){
      const { data, pronouns } = getCurrentData();
      const table = els.fillTable;
      table.innerHTML = `
        <tr><th></th><th>1st</th><th>2nd</th><th>3rd</th></tr>
        <tr><th>Singular</th>
          <td><input data-correct="${data.singular[1]}" placeholder="${pronouns.singular[1]}"></td>
          <td><input data-correct="${data.singular[2]}" placeholder="${pronouns.singular[2]}"></td>
          <td><input data-correct="${data.singular[3]}" placeholder="${pronouns.singular[3]}"></td>
        </tr>
        <tr><th>Plural</th>
          <td><input data-correct="${data.plural[1]}" placeholder="${pronouns.plural[1]}"></td>
          <td><input data-correct="${data.plural[2]}" placeholder="${pronouns.plural[2]}"></td>
          <td><input data-correct="${data.plural[3]}" placeholder="${pronouns.plural[3]}"></td>
        </tr>`;
    }

    function checkAnswers(){
      const inputs = els.fillTable.querySelectorAll('input');
      let correct=0;
      inputs.forEach(inp=>{
        if(inp.value.trim().toLowerCase()===inp.dataset.correct.trim().toLowerCase()){
          inp.classList.add('correct'); correct++;
        } else inp.classList.add('incorrect');
      });
      els.correctCount.textContent = correct;
    }

    function resetGame(){
      createFillTable();
      els.correctCount.textContent='0';
      els.scoreDisplay.textContent='0%';
    }

    function toggleAnswers(){
      document.querySelectorAll('#fillTable input').forEach(i=>i.value=i.dataset.correct);
    }

    loadLesson();
  </script>
</body>
</html>
